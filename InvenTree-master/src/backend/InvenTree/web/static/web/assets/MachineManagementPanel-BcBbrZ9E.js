import{j as e,r as x,N as p,d as h,am as $,c as b,ao as v,ab as i,aq as A,an as C,bj as X,M as J,e as re,bE as xe,S as y,as as a,$ as L,ap as O,bc as ue,bM as k,cU as Q,ak as B,cH as pe,a8 as je,aB as E,T as U,ac as ne}from"./index-Db7AGPIq.js";import{a as G,x as N,v as q,aP as _e,S as _,r as ee}from"./ThemeContext-CxdCkKtz.js";import{M as ie,G as ve}from"./SettingList-Bc72M5k9.js";import{ao as fe,a as ge,c as te,b as ae,d as ye,p as be,f as Ce}from"./Filter-BgnAqEQC.js";import{Y as V}from"./YesNoButton-BaVgP5u9.js";import{u as H,R as Me,a as we,I as Z,O as Fe,E as Te,D as ke}from"./InvenTreeTable-DmN557zY.js";import{I as m}from"./InfoItem-CKE41Z9j.js";import{I as Ie}from"./IconAlertCircle-DEV3UHRn.js";import{D as K,a as se}from"./DetailDrawer-DtwyRZtv.js";import{u as le}from"./DesktopAppView-BuH2j218.js";import{B as S,D as ce}from"./ColumnRenderers-BUH0stTX.js";import"./ActionButton-Cv5j5I5R.js";import"./IconChevronDown-CzbIU38Y.js";import"./index-DRtKJP-e.js";import"./QRCode-BaIEIQ2d.js";import"./browser-DSycY7kT.js";import"./IconDotsVertical-D8D3XsjG.js";import"./IconTags-DnGx22aA.js";import"./IconChevronLeft-6FmaJpTs.js";import"./formatters-B4ehJgEk.js";function R(){return e.jsx(Ie,{size:18,color:"red"})}function oe({machine:n}){const o={marginLeft:"4px"};if(!n.active)return e.jsx(X,{style:o,color:"gray",children:e.jsx(J,{})});let d="green";n.machine_errors.length>0||!n.is_driver_available||n.status>=300?d="red":n.status>=200&&(d="orange");const s=n.initialized&&n.status>0&&n.status<300;return e.jsx(X,{processing:s,style:o,color:d,children:e.jsx(J,{})})}function de({machinePk:n,callback:o}){re.post(C(v.machine_restart,void 0,{machine:n})).then(()=>{xe.show({message:i._({id:"8hvWaA"}),color:"green",icon:e.jsx(_e,{size:"1rem"})}),o?.()})}function P({includeTypes:n=!0,includeDrivers:o=!0}={}){const d=le(),{data:l,isFetching:s,refetch:t}=q({enabled:n,queryKey:["machine-types"],queryFn:()=>d.get(C(v.machine_types_list)).then(w=>w.data),staleTime:10*1e3}),{data:f,isFetching:j,refetch:g}=q({enabled:o,queryKey:["machine-drivers"],queryFn:()=>d.get(C(v.machine_driver_list)).then(w=>w.data),staleTime:10*1e3}),M=x.useCallback(()=>{t(),g()},[g,t]);return{machineTypes:l,machineDrivers:f,isFetching:s||j,refresh:M}}function De({machinePk:n,refreshTable:o}){const d=le(),l=G(),{data:s,refetch:t,isLoading:f}=q({enabled:!0,queryKey:["machine-detail",n],refetchInterval:5*1e3,queryFn:()=>d.get(C(v.machine_list,n)).then(u=>u.data)}),{machineTypes:j,machineDrivers:g,isFetching:M}=P(),w=f||M,F=x.useMemo(()=>j&&s?j.find(u=>u.slug===s.machine_type):void 0,[s?.machine_type,j]),I=x.useMemo(()=>g&&s?g.find(u=>u.slug===s.driver):void 0,[s?.driver,g]),T=x.useCallback(()=>{t(),o()},[t,o]),D=ae({title:i._({id:"RBquff"}),url:v.machine_list,pk:n,fields:x.useMemo(()=>({name:{},active:{}}),[]),onClose:()=>T()}),z=te({title:i._({id:"5ihjEH"}),successMessage:i._({id:"ZbXCol"}),url:v.machine_list,pk:n,preFormContent:e.jsx(A,{color:"red",children:i._({id:"nlccfe"})}),onFormSuccess:()=>{o(),l(-1)}}),W=x.useMemo(()=>{if(!s?.properties)return[];const u=[],r={};for(const c of s.properties)u.includes(c.group)||u.push(c.group),r[c.group]||(r[c.group]=[]),r[c.group].push(c);return u.map(c=>({group:c,properties:r[c]}))},[s?.properties]);return e.jsx(e.Fragment,{children:e.jsxs(y,{gap:"xs",children:[D.modal,z.modal,e.jsxs(p,{justify:"space-between",children:[e.jsxs(p,{children:[s&&e.jsx(oe,{machine:s}),e.jsx(_,{size:"md",children:s?.name??i._({id:"HCk1Xx"})})]}),e.jsxs(p,{children:[s?.restart_required&&e.jsx($,{color:"red",children:e.jsx(b,{id:"dKwnjv"})}),e.jsx(Fe,{tooltip:i._({id:"72f9dQ"}),actions:[Te({tooltip:i._({id:"RBquff"}),onClick:D.open}),ke({tooltip:i._({id:"5ihjEH"}),onClick:z.open}),{icon:e.jsx(N,{}),name:i._({id:"6z9W13"}),tooltip:i._({id:"Plnldt"})+(s?.restart_required?` (${i._({id:"kbLjlB"})})`:""),indicator:s?.restart_required?{color:"red"}:void 0,onClick:()=>{s&&de({machinePk:s?.pk,callback:T})}}]})]})]}),e.jsxs(a,{multiple:!0,defaultValue:["machine-info","machine-properties","machine-settings","driver-settings"],children:[e.jsxs(a.Item,{value:"machine-info",children:[e.jsx(a.Control,{children:e.jsx(_,{size:"lg",children:i._({id:"Weq9zb"})})}),e.jsx(a.Panel,{children:e.jsx(L,{withBorder:!0,p:"md",children:e.jsx(y,{gap:"md",children:e.jsxs(y,{pos:"relative",gap:"xs",children:[e.jsx(O,{visible:w,overlayProps:{opacity:0}}),e.jsx(m,{name:i._({id:"pwL+bm"}),children:e.jsxs(p,{gap:"xs",children:[F?e.jsx(se,{to:`../type-${s?.machine_type}`,text:F.name}):e.jsx(h,{children:s?.machine_type}),s&&!F&&e.jsx(R,{})]})}),e.jsx(m,{name:i._({id:"3ADt1I"}),children:e.jsxs(p,{gap:"xs",children:[I?e.jsx(se,{to:`../driver-${s?.driver}`,text:I.name}):e.jsx(h,{children:s?.driver}),!s?.is_driver_available&&e.jsx(R,{})]})}),e.jsx(m,{name:i._({id:"nsu9Un"}),children:e.jsx(V,{value:s?.initialized||!1})}),e.jsx(m,{name:i._({id:"F6pfE9"}),children:e.jsx(V,{value:s?.active||!1})}),e.jsx(m,{name:i._({id:"uAQUqI"}),children:e.jsxs(ue,{direction:"column",children:[s?.status===-1?e.jsx(h,{fz:"xs",children:"No status"}):be({status:`${s?.status||-1}`,type:`${s?.status_model}`}),e.jsx(h,{fz:"sm",children:s?.status_text})]})}),e.jsxs(p,{justify:"space-between",gap:"xs",children:[e.jsxs(h,{fz:"sm",fw:700,children:[e.jsx(b,{id:"UirGxE"}),":"]}),s&&s?.machine_errors.length>0?e.jsx($,{color:"red",style:{marginLeft:"10px"},children:s?.machine_errors.length}):e.jsx(h,{fz:"xs",children:e.jsx(b,{id:"hIOaIF"})}),e.jsx(k,{w:"100%",children:s?.machine_errors.map((u,r)=>e.jsx(k.Item,{children:e.jsx(Q,{children:u})},r))})]})]})})})})]},`machine-info-${n}`),e.jsxs(a.Item,{value:"machine-properties",children:[e.jsx(a.Control,{children:e.jsx(_,{size:"lg",children:i._({id:"l/UFPv"})})}),e.jsx(a.Panel,{children:e.jsx(L,{withBorder:!0,p:"md",children:e.jsx(y,{gap:"sm",children:W.map(({group:u,properties:r})=>e.jsxs(y,{gap:0,children:[u&&e.jsx(h,{fz:"sm",fw:700,mb:2,children:u}),e.jsx(B,{variant:"vertical",withTableBorder:!0,verticalSpacing:4,children:e.jsx(B.Tbody,{children:r.map(c=>e.jsxs(B.Tr,{children:[e.jsx(B.Th,{w:250,children:c.key}),e.jsx(B.Td,{children:c.type==="bool"?e.jsx(V,{value:`${c.value}`.toLowerCase()==="true"}):c.type==="progress"?e.jsxs(p,{children:[e.jsx(pe,{value:Number.parseInt(c.value)/c.max_progress*100,flex:1}),e.jsxs(h,{children:[c.value," / ",c.max_progress]})]}):c.type==="int"?e.jsx(h,{size:"sm",children:c.value}):c.type==="float"?e.jsx(h,{size:"sm",children:Ce(Number.parseFloat(c.value),{digits:4})}):e.jsx(h,{size:"sm",children:c.value})})]},c.key))})})]},u))})})})]},`machine-properties-${n}`),s?.is_driver_available&&e.jsxs(a.Item,{value:"machine-settings",children:[e.jsx(a.Control,{children:e.jsx(_,{size:"lg",children:i._({id:"m57e2B"})})}),e.jsx(a.Panel,{children:e.jsx(L,{withBorder:!0,p:"xs",children:e.jsx(ie,{machinePk:n,configType:"M",onChange:T})})})]},`machine-settings-${n}`),s?.is_driver_available&&e.jsxs(a.Item,{value:"driver-settings",children:[e.jsx(a.Control,{children:e.jsx(_,{size:"lg",children:i._({id:"fWJCep"})})}),e.jsx(a.Panel,{children:e.jsx(L,{withBorder:!0,p:"xs",children:e.jsx(ie,{machinePk:n,configType:"D",onChange:T})})})]},`driver-settings-${n}`)]})]})})}function he({props:n,renderMachineDrawer:o=!0,createProps:d}){const{machineTypes:l,machineDrivers:s}=P(),t=H("machine"),f=G(),j=x.useMemo(()=>[{accessor:"name",sortable:!0,render:r=>e.jsxs(p,{justify:"left",wrap:"nowrap",children:[e.jsx(oe,{machine:r}),e.jsx(h,{children:r.name}),r.restart_required&&e.jsx($,{color:"red",children:e.jsx(b,{id:"dKwnjv"})})]})},{accessor:"machine_type",sortable:!0,render:r=>{const c=l?.find(Y=>Y.slug===r.machine_type);return e.jsxs(p,{gap:"xs",children:[e.jsx(h,{children:c?c.name:r.machine_type}),l&&!c&&e.jsx(R,{})]})}},{accessor:"driver",sortable:!0,render:r=>{const c=s?.find(Y=>Y.slug===r.driver);return e.jsxs(p,{gap:"xs",children:[e.jsx(h,{children:c?c.name:r.driver}),!r.is_driver_available&&e.jsx(R,{})]})}},S({accessor:"initialized"}),S({accessor:"active"}),{accessor:"status",sortable:!1,render:r=>{const c=fe(`${r.status_model}`);if(c&&r.status!==-1)return c(r)}},{accessor:"status_text",sortable:!1},{accessor:"machine_errors",sortable:!1,render:r=>r.machine_errors.join(", ")}],[l]),[g,M]=x.useState(null),w=x.useMemo(()=>s?s.filter(r=>r.machine_type===g).map(r=>({value:r.slug,display_name:r.name})):[],[s,g]),F=ge({title:i._({id:"V0xlx2"}),url:v.machine_list,fields:{name:{},machine_type:{hidden:!!d?.machine_type,...d?.machine_type?{value:d.machine_type}:{},field_type:"choice",choices:l?l.map(r=>({value:r.slug,display_name:r.name})):[],onValueChange:r=>M(r)},driver:{hidden:!!d?.driver,...d?.driver?{value:d.driver}:{},field_type:"choice",disabled:!g,choices:w},active:{}},onFormSuccess:r=>{t.refreshTable(),f(o?`machine-${r.pk}/`:`../machine-${r.pk}/`)},onClose:()=>{M(null)}}),[I,T]=x.useState(void 0),D=te({title:i._({id:"ao1fGg"}),successMessage:i._({id:"ZbXCol"}),url:v.machine_list,pk:I,preFormContent:e.jsx(A,{color:"red",children:i._({id:"nlccfe"})}),table:t}),z=ae({title:i._({id:"tm3/7b"}),url:v.machine_list,pk:I,fields:{name:{},active:{}},table:t}),W=x.useCallback(r=>[{icon:e.jsx(N,{}),title:i._({id:"uhHBvD"}),onClick:()=>{de({machinePk:r.pk,callback:()=>{t.refreshTable()}})}},Me({title:i._({id:"RBquff"}),onClick:()=>{T(r.pk),z.open()}}),we({title:i._({id:"ao1fGg"}),onClick:()=>{T(r.pk),D.open()}})],[]),u=x.useMemo(()=>[e.jsx(ye,{tooltip:i._({id:"kZ/tbb"}),onClick:()=>{M(null),F.open()}},"add-machine")],[F.open]);return e.jsxs(e.Fragment,{children:[F.modal,z.modal,D.modal,o&&e.jsx(K,{title:i._({id:"YDOU4Q"}),size:"xl",renderContent:r=>!r||!r.startsWith("machine-")?!1:e.jsx(De,{machinePk:r.replace("machine-",""),refreshTable:t.refreshTable})}),e.jsx(Z,{url:C(v.machine_list),tableState:t,columns:j,props:{...n,enableDownload:!1,onRowClick:r=>f(o?`machine-${r.pk}/`:`../machine-${r.pk}/`),rowActions:W,tableActions:u,params:{...n.params},tableFilters:[{name:"active",label:i._({id:"F6pfE9"}),type:"boolean"},{name:"machine_type",label:i._({id:"pwL+bm"}),type:"choice",choiceFunction:()=>l?l.map(r=>({value:r.slug,label:r.name})):[]},{name:"driver",label:i._({id:"6ccUsd"}),type:"choice",choiceFunction:()=>s?s.map(r=>({value:r.slug,label:r.name})):[]}]}})]})}function me({machineType:n,prefix:o}){const d=G(),l=H("machine-drivers"),s=x.useMemo(()=>[{accessor:"name",title:i._({id:"6YtxFj"})},ce({}),{accessor:"machine_type",title:i._({id:"Epj9T5"})},S({accessor:"is_builtin",title:i._({id:"argeGI"})})],[]);return e.jsx(Z,{url:C(v.machine_driver_list),tableState:l,columns:s,props:{enableDownload:!1,enableSearch:!1,onRowClick:t=>{d(`${o??"."}/driver-${t.slug}/`)},dataFormatter:t=>n?t.filter(f=>f.machine_type===n):t}})}function ze({machineTypeSlug:n}){const{machineTypes:o,isFetching:d}=P({includeDrivers:!1}),l=x.useMemo(()=>o?.find(s=>s.slug===n),[o,n]);return e.jsx(e.Fragment,{children:e.jsxs(y,{children:[e.jsx(p,{wrap:"nowrap",children:e.jsx(_,{size:"md",children:l?l.name:n})}),!l&&e.jsx(A,{color:"red",title:i._({id:"pAtylB"}),icon:e.jsx(je,{}),children:e.jsx(h,{children:i._({id:"FW2Ygg"})})}),e.jsxs(a,{multiple:!0,defaultValue:["machine-type-info","machine-drivers"],children:[e.jsxs(a.Item,{value:"machine-type-info",children:[e.jsx(a.Control,{children:e.jsx(_,{size:"lg",children:i._({id:"RRr8s4"})})}),e.jsx(a.Panel,{children:e.jsx(E,{withBorder:!0,children:e.jsxs(y,{pos:"relative",gap:"xs",children:[e.jsx(O,{visible:d,overlayProps:{opacity:0}}),e.jsx(m,{name:i._({id:"6YtxFj"}),value:l?.name,type:"text"}),e.jsx(m,{name:i._({id:"L85WcV"}),value:l?.slug,type:"text"}),e.jsx(m,{name:i._({id:"Nu4oKW"}),value:l?.description,type:"text"}),!l?.is_builtin&&e.jsx(m,{name:i._({id:"umAemZ"}),value:l?.provider_plugin?.name,type:"text",link:l?.provider_plugin?.pk!==null?`../../plugin/${l?.provider_plugin?.pk}/`:void 0,detailDrawerLink:!0}),e.jsx(m,{name:i._({id:"jfVQG5"}),value:l?.provider_file,type:"code"}),e.jsx(m,{name:i._({id:"++LBSt"}),value:l?.is_builtin,type:"boolean"})]})})})]}),e.jsxs(a.Item,{value:"machine-drivers",children:[e.jsx(a.Control,{children:e.jsx(_,{size:"lg",children:i._({id:"qTGFbM"})})}),e.jsx(a.Panel,{children:e.jsx(E,{withBorder:!0,children:e.jsx(me,{machineType:n,prefix:".."})})})]})]})]})})}function Be({machineDriverSlug:n}){const{machineDrivers:o,machineTypes:d,refresh:l,isFetching:s}=P(),t=x.useMemo(()=>o?.find(j=>j.slug===n),[o,n]),f=x.useMemo(()=>d?.find(j=>j.slug===t?.machine_type),[o,d]);return e.jsxs(y,{children:[e.jsx(p,{justify:"center",children:e.jsx(U,{order:4,children:t?t.name:n})}),!t&&e.jsx(h,{style:{fontStyle:"italic"},children:e.jsx(b,{id:"p6inm0"})}),e.jsx(E,{withBorder:!0,children:e.jsxs(y,{gap:"md",children:[e.jsxs(p,{justify:"space-between",children:[e.jsx(U,{order:4,children:e.jsx(b,{id:"Dm7Jy5"})}),e.jsx(ne,{variant:"outline",onClick:()=>l(),children:e.jsx(N,{})})]}),e.jsxs(y,{pos:"relative",gap:"xs",children:[e.jsx(O,{visible:s,overlayProps:{opacity:0}}),e.jsx(m,{name:i._({id:"6YtxFj"}),value:t?.name,type:"text"}),e.jsx(m,{name:i._({id:"L85WcV"}),value:t?.slug,type:"text"}),e.jsx(m,{name:i._({id:"Nu4oKW"}),value:t?.description,type:"text"}),e.jsx(m,{name:i._({id:"I+nMNp"}),value:f?f.name:t?.machine_type,type:"text",link:f?`../type-${t?.machine_type}`:void 0,detailDrawerLink:!0}),!t?.is_builtin&&e.jsx(m,{name:i._({id:"umAemZ"}),value:t?.provider_plugin?.name,type:"text",link:t?.provider_plugin?.pk!==null?`../../plugin/${t?.provider_plugin?.pk}/`:void 0,detailDrawerLink:!0}),e.jsx(m,{name:i._({id:"jfVQG5"}),value:t?.provider_file,type:"code"}),e.jsx(m,{name:i._({id:"++LBSt"}),value:t?.is_builtin,type:"boolean"}),e.jsxs(p,{justify:"space-between",gap:"xs",children:[e.jsxs(h,{fz:"sm",fw:700,children:[e.jsx(b,{id:"UirGxE"}),":"]}),t&&t?.driver_errors.length>0?e.jsx($,{color:"red",style:{marginLeft:"10px"},children:t.driver_errors.length}):e.jsx(h,{fz:"xs",children:e.jsx(b,{id:"hIOaIF"})}),e.jsx(k,{w:"100%",children:t?.driver_errors.map((j,g)=>e.jsx(k.Item,{children:e.jsx(Q,{children:j})},`${g}-${j}`))})]})]})]})}),e.jsx(E,{withBorder:!0,children:e.jsxs(y,{gap:"md",children:[e.jsx(U,{order:4,children:e.jsx(b,{id:"Qf5DYN"})}),e.jsx(he,{props:{params:{driver:n}},renderMachineDrawer:!1,createProps:{machine_type:t?.machine_type,driver:n}})]})})]})}function Ae({props:n}){const o=H("machineTypes"),d=G(),l=x.useMemo(()=>[{accessor:"name",title:i._({id:"6YtxFj"})},ce({}),S({accessor:"is_builtin",title:i._({id:"eBtH/D"})})],[]);return e.jsxs(e.Fragment,{children:[e.jsx(K,{title:i._({id:"qRwuAd"}),size:"xl",renderContent:s=>!s||!s.startsWith("type-")?!1:e.jsx(ze,{machineTypeSlug:s.replace("type-","")})}),e.jsx(K,{title:i._({id:"RYeia3"}),size:"xl",renderContent:s=>!s||!s.startsWith("driver-")?!1:e.jsx(Be,{machineDriverSlug:s.replace("driver-","")})}),e.jsx(Z,{url:C(v.machine_types_list),tableState:o,columns:l,props:{...n,enableDownload:!1,enableSearch:!1,onRowClick:s=>d(`./type-${s.slug}/`),params:{...n.params}}})]})}function ei(){const{data:n,refetch:o}=q({queryKey:["machine-registry-status"],queryFn:()=>re.get(C(v.machine_registry_status)).then(l=>l.data),staleTime:1e4}),d=x.useMemo(()=>n?.registry_errors&&n.registry_errors.length>0,[n]);return e.jsxs(a,{multiple:!0,defaultValue:["machinelist"],children:[e.jsxs(a.Item,{value:"machinelist",children:[e.jsx(a.Control,{children:e.jsx(_,{size:"lg",children:i._({id:"Qf5DYN"})})}),e.jsx(a.Panel,{children:e.jsx(he,{props:{}})})]}),e.jsxs(a.Item,{value:"drivertypes",children:[e.jsx(a.Control,{children:e.jsx(_,{size:"lg",children:i._({id:"gdLGGi"})})}),e.jsx(a.Panel,{children:e.jsx(me,{})})]}),e.jsxs(a.Item,{value:"machinetypes",children:[e.jsx(a.Control,{children:e.jsx(_,{size:"lg",children:i._({id:"XyzprV"})})}),e.jsx(a.Panel,{children:e.jsx(Ae,{props:{}})})]}),e.jsxs(a.Item,{value:"machineerrors",children:[e.jsx(a.Control,{children:e.jsx(_,{size:"lg",children:i._({id:"Y7d3OC"})})}),e.jsx(a.Panel,{children:e.jsxs(y,{gap:"xs",children:[e.jsxs(p,{justify:"space-beteen",wrap:"nowrap",style:{width:"100%"},children:[d?e.jsx(A,{flex:10,color:"red",title:i._({id:"iXdfqc"}),icon:e.jsx(ee,{}),children:e.jsx(h,{children:i._({id:"2U2qZc"})})}):e.jsx(A,{flex:10,color:"green",title:i._({id:"32TD49"}),icon:e.jsx(ee,{}),children:e.jsx(h,{children:i._({id:"Jb0bCL"})})}),e.jsx(ne,{variant:"outline",onClick:()=>o(),children:e.jsx(N,{})})]}),d&&e.jsx(k,{children:n?.registry_errors?.map((l,s)=>e.jsx(k.Item,{children:e.jsx(Q,{children:l.message})},s))})]})})]}),e.jsxs(a.Item,{value:"settings",children:[e.jsx(a.Control,{children:e.jsx(_,{size:"lg",children:i._({id:"m57e2B"})})}),e.jsx(a.Panel,{children:e.jsx(ve,{keys:["MACHINE_PING_ENABLED"]})})]})]})}export{ei as default};
//# sourceMappingURL=MachineManagementPanel-BcBbrZ9E.js.map
