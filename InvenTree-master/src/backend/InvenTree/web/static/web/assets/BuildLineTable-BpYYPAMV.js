import{K as ge,r as o,ab as e,an as L,ao as k,j as s,N as I,am as ye,aa as Ce,ac as Te,bg as Se,d,bb as v,ag as oe,b1 as j,$ as ve,a7 as we,aq as Z}from"./index-Db7AGPIq.js";import{v as Re,a9 as te,a as ne,ac as qe,af as se,F as ae,ag as Fe}from"./ThemeContext-CxdCkKtz.js";import{P as Ae}from"./YesNoButton-BaVgP5u9.js";import{a as P,n as Me,T as J,F as Be,C as ze,E as Le,D as Ie,H as Pe,B as Ee,z as Oe,i as De,d as Ve,P as Ne,f as q,b as Qe,c as Je}from"./Filter-BgnAqEQC.js";import{u as We}from"./DesktopAppView-BuH2j218.js";import{f as Ge}from"./formatters-B4ehJgEk.js";import{e as Ue}from"./PluginUIFeature-DCu8wTdG.js";import{u as X,I as K,R as Ye,c as re}from"./InvenTreeTable-DmN557zY.js";import{P as $,f as de,C as Ze,D as He,B,c as Xe,g as Ke}from"./ColumnRenderers-BUH0stTX.js";import{A as z}from"./ActionButton-Cv5j5I5R.js";import{P as H}from"./index-DRtKJP-e.js";import{O as $e}from"./OrderPartsWizard-BcMgRjfh.js";import{d as et,e as tt,f as st}from"./BuildForms-BotNgtQh.js";import{u as at}from"./ImporterForms-D2fp0CPO.js";import{R as it}from"./RowExpansionIcon-DC7o6kBm.js";import{b as ie}from"./IconChevronDown-CzbIU38Y.js";import{I as le}from"./IconCircleDashedCheck-DnGBn8Eq.js";/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const lt=[["path",{d:"M6 21l15 -15l-3 -3l-15 15l3 3",key:"svg-0"}],["path",{d:"M15 6l3 3",key:"svg-1"}],["path",{d:"M9 3a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2",key:"svg-2"}],["path",{d:"M19 13a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2",key:"svg-3"}]],ot=ge("outline","wand","Wand",lt);function St({buildId:c,partId:i}){const T=o.useMemo(()=>c?"build-test-results":"part-test-results",[c]),u=X(T),w=We(),{data:p}=Re({queryKey:["build-test-templates",i,c],queryFn:async()=>i?w.get(L(k.part_test_template_list),{params:{part:i,include_inherited:!0,enabled:!0,required:!0}}).then(m=>m.data):[]});o.useEffect(()=>{u.refreshTable()},[p]);const[b,a]=o.useState(0),[x,E]=o.useState(void 0),F=Ue({partId:i,itemId:b,templateId:x}),A=P({url:L(k.stock_test_result_list),title:e._({id:"VzkBcq"}),fields:F,initialData:{template:x,result:!0},onFormSuccess:()=>u.refreshTable(),successMessage:e._({id:"VivtT0"})}),W=o.useMemo(()=>{const m={...F};return delete m.attachment,delete m.stock_item,m.template.disabled=!1,m},[i,F]),G=o.useCallback((m,f)=>u.selectedRecords.map(h=>({...m,stock_item:h.pk})),[u.selectedIds]),O=P({url:L(k.stock_test_result_list),title:e._({id:"t+Eo6q"}),fields:W,initialData:{result:!0},onFormSuccess:()=>{u.clearSelectedRecords(),u.refreshTable()},processFormData:G,successMessage:e._({id:"1QgWBV"})}),M=o.useMemo(()=>!p||p.length==0?[]:p.map(m=>({accessor:`test_${m.pk}`,title:m.test_name,sortable:!1,switchable:!0,render:f=>{const h=(f.tests||[]).filter(C=>C.template==m.pk).sort((C,Q)=>Q.pk-C.pk).shift();if(!h||h.result===void 0)return s.jsxs(I,{gap:"xs",wrap:"nowrap",justify:"space-between",children:[s.jsx(ye,{color:"lightblue",variant:"filled",children:e._({id:"4bobEy"})}),s.jsx(Ce,{label:e._({id:"VzkBcq"}),children:s.jsx(Te,{size:"lg",color:"green","aria-label":"add-test-result",variant:"transparent",onClick:C=>{Se(C),a(f.pk),E(m.pk),A.open()},children:s.jsx(te,{})})})]});const y=[];return h.value&&y.push(s.jsxs(d,{size:"sm",children:[e._({id:"wMHvYH"}),": ",h.value]},"value")),h.notes&&y.push(s.jsxs(d,{size:"sm",children:[e._({id:"1DBGsz"}),": ",h.notes]},"notes")),h.date&&y.push(s.jsxs(d,{size:"sm",children:[e._({id:"mYGY3B"}),": ",Ge(h.date)]},"date")),h.user_detail&&y.push(s.jsx(Me,{instance:h.user_detail},"user")),s.jsx(J,{value:s.jsx(Ae,{value:h.result}),title:m.test_name,extra:y})}})),[p]),D=o.useMemo(()=>[...[$({title:e._({id:"vgP+9p"}),part:"part_detail",full_name:!0,ordering:"part",sortable:!0,switchable:!0}),{accessor:"stock",title:e._({id:"igx8Og"}),sortable:!0,switchable:!1,render:f=>{if(f.serial)return`# ${f.serial}`;{const g=[];return f.batch&&g.push(s.jsxs(d,{size:"sm",children:[e._({id:"Vea6Aj"}),": ",f.batch]},"batch")),s.jsx(J,{value:s.jsxs(d,{children:[e._({id:"VbWX2u"}),": ",f.quantity]}),title:e._({id:"gILim+"}),extra:g})}}},{accessor:"batch",title:e._({id:"Vea6Aj"}),sortable:!0,switchable:!0},de({accessor:"location_detail"})],...M],[M]),V=o.useMemo(()=>[{name:"is_building",label:e._({id:"BE5Q6v"}),description:e._({id:"AO8gAN"})},Be(),ze(),Le(),Ie(),Pe(),Ee(),Oe(),{name:"status",label:e._({id:"uAQUqI"}),description:e._({id:"+Jr1e4"}),choiceFunction:De(v.stockitem)}],[]),R=o.useMemo(()=>[s.jsx(Ve,{tooltip:e._({id:"VzkBcq"}),disabled:!u.hasSelectedRecords,onClick:m=>{O.open()}},"add-test-result")],[u.hasSelectedRecords]),N=o.useCallback(m=>[{icon:s.jsx(te,{}),color:"green",title:e._({id:"VzkBcq"}),onClick:f=>{a(m.pk),E(void 0),A.open()}}],[]);return s.jsxs(s.Fragment,{children:[A.modal,O.modal,s.jsx(K,{url:L(k.stock_item_list),tableState:u,columns:D,props:{params:{part_detail:!0,location_detail:!0,tests:!0,part:i,build:c},enableSelection:!0,rowActions:N,tableFilters:V,tableActions:R,modelType:v.stockitem}})]})}function nt({lineItem:c,onEditAllocation:i,onDeleteAllocation:T}){const u=oe(),w=ne(),p=X("buildline-subtable"),b=o.useMemo(()=>[$({part:"part_detail"}),{accessor:"quantity",title:e._({id:"VbWX2u"}),render:x=>x.stock_item_detail?.serial?`# ${x.stock_item_detail.serial}`:x.quantity},{accessor:"stock_item_detail.batch",title:e._({id:"rsx3xA"})},de({accessor:"location_detail"})],[]),a=o.useCallback(x=>[Ye({hidden:!i||!u.hasChangeRole(j.build),onClick:()=>{i?.(x.pk)}}),{title:e._({id:"t/YqKh"}),tooltip:e._({id:"GN9iO5"}),icon:s.jsx(qe,{}),color:"red",hidden:!T||!u.hasDeleteRole(j.build),onClick:()=>{T?.(x.pk)}},re({title:e._({id:"f6f1i/"}),modelType:v.stockitem,modelId:x.stock_item,navigate:w})],[u,i,T]);return s.jsx(ve,{p:"xs",children:s.jsx(K,{tableState:p,columns:b,tableData:c.filteredAllocations??c.allocations,props:{minHeight:200,enableSearch:!1,enableRefresh:!1,enableColumnSwitching:!1,enableFilters:!1,rowActions:a,noRecordsText:""}})})}function vt({build:c,output:i,params:T={}}){const u=oe(),w=ne(),p=at({modelType:v.build}),b=o.useMemo(()=>!!i?.pk,[i]),a=X(b?"buildline-output":"buildline"),x=o.useMemo(()=>c?.status==p.PRODUCTION||c?.status==p.PENDING||c?.status==p.ON_HOLD,[c,p]),E=o.useMemo(()=>[{name:"allocated",label:e._({id:"A/ybx7"}),description:e._({id:"/EiduX"})},{name:"consumed",label:e._({id:"XNITBt"}),description:e._({id:"ATuQJ1"})},{name:"available",label:e._({id:"csDS2L"}),description:e._({id:"Gm8vyo"})},{name:"consumable",label:e._({id:"duCsZf"}),description:e._({id:"4xoOP+"})},{name:"optional",label:e._({id:"LLAa/9"}),description:e._({id:"JZ0XU+"})},{name:"assembly",label:e._({id:"WL36Yh"}),description:e._({id:"yTd5+B"})},{name:"testable",label:e._({id:"bJsTOf"}),description:e._({id:"LCdyP7"})},{name:"tracked",label:e._({id:"EaG6cP"}),description:e._({id:"lY29Qz"})},{name:"on_order",label:e._({id:"0lg3zX"}),description:e._({id:"tTYYpj"})},Ne()],[]),F=o.useCallback(t=>{const l=t?.bom_item_detail??{},n=[];let r=t?.available_stock;t.available_substitute_stock>0&&(r+=t.available_substitute_stock,n.push(s.jsx(d,{size:"sm",children:e._({id:"XTe+lK"})},"substitite"))),l.allow_variants&&t.available_variant_stock>0&&(r+=t.available_variant_stock,n.push(s.jsx(d,{size:"sm",children:e._({id:"LdvJ9e"})},"variant"))),t.in_production>0&&n.push(s.jsxs(d,{size:"sm",children:[e._({id:"G1xXyB"}),": ",q(t.in_production)]},"production")),t.on_order>0&&n.push(s.jsxs(d,{size:"sm",children:[e._({id:"/MB+gl"}),": ",q(t.on_order)]},"on-order")),t.external_stock>0&&n.push(s.jsxs(d,{size:"sm",children:[e._({id:"e8fwfT"}),": ",q(t.external_stock)]},"external"));const _=r>=t.quantity-t.allocated;return _||n.push(s.jsx(d,{c:"orange",size:"sm",children:e._({id:"R7+e2m"})},"insufficient")),s.jsx(J,{icon:_?"info":"exclamation",iconColor:_?"blue":"orange",value:r>0?`${q(r)}`:s.jsx(d,{c:"red",style:{fontStyle:"italic"},children:e._({id:"a5n/wL"})}),title:e._({id:"oGd3rK"}),extra:n})},[]),A=o.useMemo(()=>[$({accessor:"bom_item",part:"part_detail",ordering:"part",sortable:!0,switchable:!1,render:t=>{const l=t.allocatedQuantity>0;return s.jsxs(I,{wrap:"nowrap",children:[s.jsx(it,{enabled:l,expanded:a.isRowExpanded(t.pk)}),s.jsx(Ke,{part:t.part_detail})]})}}),{accessor:"part_detail.IPN",sortable:!1,title:e._({id:"3wXEsN"})},Ze({accessor:"category_detail",defaultVisible:!1,switchable:!0,sortable:!0,ordering:"category"}),He({accessor:"part_detail.description"}),{accessor:"bom_item_detail.reference",ordering:"reference",sortable:!0,title:e._({id:"N2C89m"})},B({accessor:"bom_item_detail.optional",ordering:"optional",hidden:b,defaultVisible:!1}),B({accessor:"bom_item_detail.consumable",ordering:"consumable",hidden:b,defaultVisible:!1}),B({accessor:"bom_item_detail.allow_variants",ordering:"allow_variants",hidden:b,defaultVisible:!1}),B({accessor:"bom_item_detail.inherited",ordering:"inherited",title:e._({id:"UF/nv9"}),hidden:b,defaultVisible:!1}),B({accessor:"part_detail.trackable",ordering:"trackable",hidden:b,defaultVisible:!1}),{accessor:"bom_item_detail.quantity",sortable:!0,title:e._({id:"O7oMsT"}),defaultVisible:!1,ordering:"unit_quantity",render:t=>s.jsxs(I,{justify:"space-between",wrap:"nowrap",children:[s.jsx(d,{children:t.bom_item_detail?.quantity}),t?.part_detail?.units&&s.jsxs(d,{size:"xs",children:["[",t.part_detail.units,"]"]})]})},{accessor:"quantity",title:e._({id:"D91mkk"}),sortable:!0,defaultVisible:!1,switchable:!1,render:t=>{const l=[];return t?.bom_item_detail?.setup_quantity&&l.push(s.jsxs(d,{size:"sm",children:[e._({id:"uweQpR"}),":"," ",q(t.bom_item_detail.setup_quantity)]},"setup-quantity")),t?.bom_item_detail?.attrition&&l.push(s.jsxs(d,{size:"sm",children:[e._({id:"SXygdJ"}),": ",t.bom_item_detail.attrition,"%"]},"attrition")),t?.bom_item_detail?.rounding_multiple&&l.push(s.jsxs(d,{size:"sm",children:[e._({id:"RKbJ2k"}),":"," ",t.bom_item_detail.rounding_multiple]},"rounding-multiple")),s.jsx(J,{title:e._({id:"mbcLng"}),extra:l,value:s.jsxs(I,{justify:"space-between",wrap:"nowrap",children:[s.jsx(d,{children:q(t.requiredQuantity)}),t?.part_detail?.units&&s.jsxs(d,{size:"xs",children:["[",t.part_detail.units,"]"]})]})})}},{accessor:"available_stock",sortable:!0,switchable:!1,render:F},{accessor:"in_production",sortable:!0,ordering:"scheduled_to_build",render:t=>t.scheduled_to_build>0?s.jsx(H,{progressLabel:!0,value:t.in_production,maximum:t.scheduled_to_build}):t.part_detail?.is_assembly?0:"-"},Xe({accessor:"on_order",defaultVisible:!1,sortable:!0}),{accessor:"allocated",switchable:!1,sortable:!0,hidden:!x,minWidth:125,render:t=>{if(t?.bom_item_detail?.consumable)return s.jsx(d,{size:"sm",style:{fontStyle:"italic"},children:e._({id:"f/GbFw"})});const l=t.allocatedQuantity??0;let n=Math.max(0,t.quantity-t.consumed);return i?.pk&&(n=t.bom_item_detail?.quantity),l<=0&&n<=0?s.jsxs(I,{gap:"xs",wrap:"nowrap",children:[s.jsx(we,{size:16,color:"green"}),s.jsx(d,{size:"sm",style:{fontStyle:"italic"},children:t.consumed>=t.quantity?e._({id:"e02p4q"}):e._({id:"rHo/AM"})})]}):s.jsx(H,{progressLabel:!0,value:l,maximum:n})}},{accessor:"consumed",sortable:!0,hidden:!!i?.pk,minWidth:125,render:t=>t?.bom_item_detail?.consumable?s.jsx(d,{style:{fontStyle:"italic"},children:e._({id:"f/GbFw"})}):s.jsx(H,{progressLabel:!0,value:t.consumed,maximum:t.requiredQuantity})}],[b,x,a,i]),W=et({create:!0,modalId:"new-build-order"}),[G,O]=o.useState({}),[M,D]=o.useState(null),[V,R]=o.useState([]),N=P({url:k.build_order_list,title:e._({id:"UcPKar"}),fields:W,modalId:"new-build-order",initialData:G,follow:!0,modelType:v.build}),m=P({url:k.build_order_auto_allocate,pk:c.pk,title:e._({id:"L1LMmH"}),fields:{location:{filters:{structural:!1}},exclude_location:{},interchangeable:{},substitutes:{},optional_items:{}},initialData:{location:c.take_from,interchangeable:!0,substitutes:!0,optional_items:!1},successMessage:e._({id:"xYIlpM"}),table:a,preFormContent:s.jsx(Z,{color:"green",title:e._({id:"PjEJ0F"}),children:s.jsx(d,{children:e._({id:"E2byp7"})})})}),f=tt({build:c,output:i,outputId:i?.pk??null,buildId:c.pk,lineItems:V,onFormSuccess:()=>{a.clearSelectedRecords(),a.refreshTable()}}),g=P({url:k.build_order_deallocate,pk:c.pk,title:e._({id:"ZZL0Jx"}),fields:{build_line:{hidden:!0},output:{hidden:!0}},initialData:{build_line:M,output:i?.pk??null},preFormContent:s.jsx(Z,{color:"red",title:e._({id:"ZZL0Jx"}),children:M==null?s.jsx(d,{children:e._({id:"9dNtWo"})}):s.jsx(d,{children:e._({id:"L01aET"})})}),successMessage:e._({id:"er7tfw"}),onFormSuccess:()=>{a.clearSelectedRecords(),a.refreshTable()}}),[h,y]=o.useState(0),C=Qe({url:k.build_item_list,pk:h,title:e._({id:"Tqnsor"}),fields:{stock_item:{disabled:!0},quantity:{}},onFormSuccess:a.refreshTable}),Q=Je({url:k.build_item_list,pk:h,title:e._({id:"pZuBa9"}),submitText:e._({id:"t/YqKh"}),onFormSuccess:a.refreshTable,preFormContent:s.jsx(Z,{color:"red",title:e._({id:"f/P5VY"}),children:e._({id:"NgdYvc"})})}),[ce,ee]=o.useState([]),U=$e({parts:ce}),Y=st({buildId:c.pk,buildLines:V,onFormSuccess:()=>{a.clearSelectedRecords(),a.refreshTable()}}),ue=o.useCallback(t=>{const l=t.part_detail??{},n=c.status==p.PRODUCTION,r=t.bom_item_detail?.consumable??!1,_=l?.trackable??!1,S=!!i?.pk,be=Math.max(0,t.quantity-t.consumed-t.allocated),he=n&&!r&&!_&&t.allocated>0&&u.hasChangeRole(j.build),fe=n&&!r&&u.hasChangeRole(j.build)&&be>0&&t.trackable==S,xe=n&&!r&&u.hasChangeRole(j.build)&&t.allocated>0&&t.trackable==S,ke=!r&&u.hasAddRole(j.purchase_order)&&l.purchaseable,je=!r&&u.hasAddRole(j.build)&&l.assembly;return[{icon:s.jsx(ie,{}),title:e._({id:"L1LMmH"}),hidden:!fe,color:"green",onClick:()=>{R([t]),f.open()}},{icon:s.jsx(le,{}),title:e._({id:"8nBqTf"}),color:"green",hidden:!he||S,onClick:()=>{R([t]),Y.open()}},{icon:s.jsx(se,{}),title:e._({id:"ZZL0Jx"}),hidden:!xe,color:"red",onClick:()=>{D(t.pk),g.open()}},{icon:s.jsx(ae,{}),title:e._({id:"cUzrZK"}),hidden:!ke,color:"blue",onClick:()=>{ee([t.part_detail]),U.openWizard()}},{icon:s.jsx(Fe,{}),title:e._({id:"vgTd7I"}),hidden:!je,color:"blue",onClick:()=>{O({part:t.part,parent:c.pk,quantity:t.quantity-t.allocated}),N.open()}},re({title:e._({id:"4BxQBj"}),modelType:v.part,modelId:t.part,navigate:w})]},[u,w,i,c,p]),me=o.useMemo(()=>{const t=c.status==p.PRODUCTION,l=u.hasChangeRole(j.build),n=t&&l;return[s.jsx(z,{icon:s.jsx(ot,{}),tooltip:e._({id:"PjEJ0F"}),hidden:!n||b,color:"blue",onClick:()=>{m.open()}},"auto-allocate"),s.jsx(z,{hidden:!u.hasAddRole(j.purchase_order),disabled:!a.hasSelectedRecords,icon:s.jsx(ae,{}),color:"blue",tooltip:e._({id:"3u5ICq"}),onClick:()=>{ee(a.selectedRecords.filter(r=>r.part_detail?.purchaseable&&r.part_detail?.active).map(r=>r.part_detail)),U.openWizard()}},"order-parts"),s.jsx(z,{icon:s.jsx(ie,{}),tooltip:e._({id:"L1LMmH"}),hidden:!n,disabled:!a.hasSelectedRecords,color:"green",onClick:()=>{let r=a.selectedRecords.filter(_=>_.allocatedQuantity<_.requiredQuantity).filter(_=>!_.bom_item_detail?.consumable);b?r=r.filter(_=>_.trackable):r=r.filter(_=>!_.trackable),R(r),f.open()}},"allocate-stock"),s.jsx(z,{icon:s.jsx(se,{}),tooltip:e._({id:"ZZL0Jx"}),hidden:!n||b,disabled:a.hasSelectedRecords,color:"red",onClick:()=>{D(null),g.open()}},"deallocate-stock"),s.jsx(z,{icon:s.jsx(le,{}),tooltip:e._({id:"8nBqTf"}),hidden:!n||b,disabled:!a.hasSelectedRecords,color:"green",onClick:()=>{R(a.selectedRecords),Y.open()}},"consume-stock")]},[u,c,p,b,a.hasSelectedRecords,a.selectedRecords]),_e=o.useCallback(t=>t.map(l=>{let n=[...l.allocations];i?.pk&&(n=n.filter(S=>S.install_into==i.pk));let r=0,_=l.quantity;return n.forEach(S=>{r+=S.quantity}),i?.quantity&&l.bom_item_detail&&(_=i.quantity*l.bom_item_detail.quantity),{...l,filteredAllocations:n,requiredQuantity:_,allocatedQuantity:r}}),[i]),pe=o.useMemo(()=>({allowMultiple:!0,expandable:({record:t})=>a.isRowExpanded(t.pk)||t.allocatedQuantity>0,content:({record:t})=>s.jsx(nt,{lineItem:t,onEditAllocation:l=>{y(l),C.open()},onDeleteAllocation:l=>{y(l),Q.open()}})}),[a.isRowExpanded,i]);return s.jsxs(s.Fragment,{children:[m.modal,N.modal,f.modal,g.modal,C.modal,Q.modal,Y.modal,U.wizard,s.jsx(K,{url:L(k.build_line_list),tableState:a,columns:A,props:{params:{...T,build:c.pk,assembly_detail:!1,category_detail:!0,part_detail:!0},tableActions:me,tableFilters:E,rowActions:ue,dataFormatter:_e,enableDownload:!0,enableSelection:!0,enableLabels:!0,modelType:v.buildline,detailAction:!1,onCellClick:()=>{},rowExpansion:pe}})]})}export{nt as B,St as P,vt as a};
//# sourceMappingURL=BuildLineTable-BpYYPAMV.js.map
