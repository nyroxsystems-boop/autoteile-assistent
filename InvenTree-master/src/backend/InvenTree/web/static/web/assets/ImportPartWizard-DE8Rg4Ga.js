import{K as W,r as o,ab as i,az as F,j as e,ao as z,e as I,an as L,av as R,S as y,N as v,ac as B,bb as D,d as k,c as d,O as b,$,am as N,ay as U,aw as H,C as Q,bd as X,bJ as Z,aa as V,T as G,aj as ee,bf as te,M as se}from"./index-Db7AGPIq.js";import{G as ae,ah as re,ai as ie,t as q,v as le,w as ne}from"./ThemeContext-CxdCkKtz.js";import{L as M}from"./DesktopAppView-BuH2j218.js";import{b as oe,M as de,N as K,I as ce}from"./Filter-BgnAqEQC.js";import{u as ue}from"./OrderPartsWizard-BcMgRjfh.js";import{S as pe}from"./StockItemTable-CHHhSxX_.js";/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=[["path",{d:"M12 5l0 14",key:"svg-0"}],["path",{d:"M18 13l-6 6",key:"svg-1"}],["path",{d:"M6 13l6 6",key:"svg-2"}]],me=W("outline","arrow-down","ArrowDown",xe);function _e({create:t=!1,duplicatePartInstance:r}){const a=F(),c=F(),[n,u]=o.useState(void 0),[_,f]=o.useState(void 0);return o.useMemo(()=>{const x={category:{filters:{structural:!1}},name:{},IPN:{},description:{},revision:{},revision_of:{filters:{is_revision:!1,is_template:!1}},variant_of:{filters:{is_template:!0}},keywords:{},units:{},link:{},default_location:{filters:{structural:!1}},default_expiry:{},minimum_stock:{},responsible:{filters:{is_active:!0}},component:{default:c.isSet("PART_COMPONENT")},assembly:{default:c.isSet("PART_ASSEMBLY")},is_template:{default:c.isSet("PART_TEMPLATE")},testable:{default:!1},trackable:{default:c.isSet("PART_TRACKABLE")},purchaseable:{value:_,default:c.isSet("PART_PURCHASEABLE"),onValueChange:j=>{f(j)}},salable:{default:c.isSet("PART_SALABLE")},virtual:{default:c.isSet("PART_VIRTUAL"),value:n,onValueChange:j=>{u(j)}},locked:{},active:{},starred:{field_type:"boolean",label:i._({id:"7VIaU3"}),description:i._({id:"wyHaGh"}),disabled:!1,required:!1}};return t&&(x.copy_category_parameters={},n!=!1&&(x.initial_stock={icon:e.jsx(ae,{}),children:{quantity:{value:0},location:{}}}),_&&(x.initial_supplier={icon:e.jsx(re,{}),children:{supplier:{filters:{is_supplier:!0}},sku:{},manufacturer:{filters:{is_manufacturer:!0}},mpn:{}}})),t&&r?.pk&&(x.duplicate={icon:e.jsx(ie,{}),children:{part:{value:r?.pk,hidden:!0},copy_image:{value:!0},copy_bom:{value:a.isSet("PART_COPY_BOM"),hidden:!r?.assembly},copy_notes:{value:!0},copy_parameters:{value:a.isSet("PART_COPY_PARAMETERS")},copy_tests:{value:!0,hidden:!r?.testable}}}),a.isSet("PART_REVISION_ASSEMBLY_ONLY")&&(x.revision_of.filters.assembly=!0),a.isSet("PART_ENABLE_REVISION")||(delete x.revision,delete x.revision_of),a.isSet("STOCK_ENABLE_EXPIRY")||delete x.default_expiry,t&&delete x.starred,x},[n,_,t,c,r,a])}function Pe({create:t}){return o.useMemo(()=>{const a={parent:{description:i._({id:"oATGL2"}),required:!1},name:{},description:{},default_location:{filters:{structural:!1}},default_keywords:{},structural:{},starred:{field_type:"boolean",label:i._({id:"7VIaU3"}),description:i._({id:"8Qu8gC"}),disabled:!1,required:!1},icon:{field_type:"icon"}};return t&&delete a.starred,a},[t])}function Ae(){return{part:{hidden:!0},quantity:{},item_count:{},cost_min:{},cost_min_currency:{},cost_max:{},cost_max_currency:{},note:{}}}const Y=({searchResult:t,partId:r,rightSection:a})=>e.jsx($,{withBorder:!0,p:"md",shadow:"xs",children:e.jsxs(v,{justify:"space-between",align:"flex-start",gap:"xs",children:[t.image_url&&e.jsx("img",{src:t.image_url,alt:t.name,style:{maxHeight:"50px"}}),e.jsxs(y,{gap:0,flex:1,children:[e.jsx("a",{href:t.link,target:"_blank",rel:"noopener noreferrer",children:e.jsxs(k,{size:"lg",w:500,children:[t.name," (",t.sku,")"]})}),e.jsx(k,{size:"sm",children:t.description})]}),e.jsxs(v,{gap:"xs",children:[t.price&&e.jsx(k,{size:"sm",c:"primary",children:t.price}),t.exact&&e.jsx(N,{size:"sm",color:"green",children:e.jsx(d,{id:"yixoBN"})}),t.existing_part_id&&r&&t.existing_part_id===r&&e.jsx(N,{size:"sm",color:"orange",children:e.jsx(d,{id:"0MGISn"})}),t.existing_part_id&&e.jsx(M,{to:`/part/${t.existing_part_id}`,children:e.jsx(N,{size:"sm",color:"blue",children:e.jsx(d,{id:"JdmfnH"})})}),a]})]})},t.id),fe=({selectSupplierPart:t,partId:r})=>{const[a,c]=o.useState(""),[n,u]=o.useState(""),[_,f]=o.useState([]),[x,j]=o.useState(!1),m=le({queryKey:["supplier-import-list"],queryFn:()=>I.get(L(z.plugin_supplier_list)).then(s=>s.data??[]),enabled:!0}),l=o.useCallback(async s=>{if(s.preventDefault(),!a||!n)return;j(!0);const[p,P]=JSON.parse(n),h=await I.get(L(z.plugin_supplier_search),{params:{plugin:p,supplier:P,term:a}});f(h.data??[]),j(!1)},[n,a]);return o.useEffect(()=>{n===""&&m.data&&m.data.length>0&&u(JSON.stringify([m.data[0].plugin_slug,m.data[0].supplier_slug]))},[m.data]),e.jsxs(y,{children:[e.jsx("form",{onSubmit:l,children:e.jsxs(v,{align:"flex-end",children:[e.jsx(U,{"aria-label":"textbox-search-for-part",flex:1,placeholder:"Search for a part",label:i._({id:"A1taO8"}),value:a,onChange:s=>c(s.currentTarget.value)}),e.jsx(H,{label:i._({id:"PYTEl0"}),value:n,onChange:s=>u(s??""),data:m.data?.map(s=>({value:JSON.stringify([s.plugin_slug,s.supplier_slug]),label:s.supplier_name}))||[],searchable:!0,disabled:m.isLoading||m.isError,placeholder:m.isLoading?i._({id:"Z3FXyt"}):m.isError?i._({id:"0Y+Is4"}):i._({id:"CrA0LQ"})}),e.jsx(b,{color:"blue",disabled:!a||!n,type:"submit",leftSection:e.jsx(ne,{}),children:e.jsx(d,{id:"A1taO8"})})]})}),x&&e.jsx(Q,{children:e.jsx(X,{})}),!x&&e.jsx(k,{size:"sm",c:"dimmed",children:e.jsx(d,{id:"hDRU5q",values:{0:_.length}})}),e.jsx(Z,{style:{maxHeight:"49vh"},children:e.jsx(y,{gap:"xs",children:_.map(s=>e.jsx(Y,{searchResult:s,partId:r,rightSection:!s.existing_part_id&&e.jsx(V,{label:i._({id:"NC6mK/"}),children:e.jsx(B,{"aria-label":`action-button-import-part-${s.id}`,onClick:()=>{const[p,P]=JSON.parse(n);t({plugin:p,supplier:P,searchResult:s})},children:e.jsx(me,{size:18})})})},s.id))})})]})},he=({categoryId:t,importPart:r,isImporting:a})=>{const[c,n]=o.useState(t);return e.jsxs(y,{children:[e.jsx(K,{fieldDefinition:{field_type:"related field",api_url:L(z.category_list),description:"",label:i._({id:"mkvLrG"}),model:D.partcategory,filters:{structural:!1},value:c,onValueChange:u=>n(u)}}),e.jsx(k,{children:e.jsx(d,{id:"5frVbW"})}),e.jsx(v,{justify:"flex-end",children:e.jsx(b,{"aria-label":"action-button-import-part-now",disabled:!c||a,onClick:()=>r(c),loading:a,children:e.jsx(d,{id:"N4/gep"})})})]})},ge=({importResult:t,isImporting:r,skipStep:a,importParameters:c,parameterErrors:n})=>{const[u,_]=o.useState(()=>t.parameters.map(l=>({...l,use:l.parameter_template!==null}))),[f,x]=o.useMemo(()=>{const l=u.filter(p=>p.on_category&&p.use).length,s=u.filter(p=>!p.on_category&&p.use).length;return[l,s]},[u]),j=o.useMemo(()=>u.filter(l=>l.on_category).length,[u]),m=o.useCallback((l,s)=>p=>_(P=>P.map((h,S)=>l===S?{...h,[s]:p}:h)),[]);return e.jsxs(y,{children:[e.jsx(k,{size:"sm",children:e.jsx(d,{id:"VzTIlR"})}),j>0&&e.jsxs(G,{order:5,children:[e.jsx(d,{id:"DTAucM"}),e.jsx(N,{ml:"xs",children:f})]}),e.jsxs(y,{gap:"xs",children:[u.map((l,s)=>e.jsxs(y,{children:[l.on_category===!1&&u[s-1]?.on_category===!0&&e.jsxs(e.Fragment,{children:[e.jsx(ee,{}),e.jsxs(G,{order:5,children:[e.jsx(d,{id:"UjFzc9"}),e.jsx(N,{ml:"xs",children:x})]})]}),e.jsxs(v,{align:"center",gap:"xs",children:[e.jsx(te,{checked:l.use,onChange:p=>m(s,"use")(p.currentTarget.checked)}),!l.on_category&&e.jsx(V,{label:l.name,children:e.jsx(k,{w:"160px",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:l.name})}),e.jsx(se,{flex:1,children:e.jsx(K,{hideLabels:!0,fieldDefinition:{field_type:"related field",model:D.parametertemplate,api_url:L(z.parameter_template_list),disabled:l.on_category,value:l.parameter_template,onValueChange:p=>{l.parameter_template||m(s,"use")(!0),m(s,"parameter_template")(p)},error:n?.[s]?.template}})}),e.jsx(U,{flex:1,value:l.value,onChange:p=>m(s,"value")(p.currentTarget.value),error:n?.[s]?.data})]})]},s)),e.jsx(V,{label:i._({id:"7Czm8D"}),children:e.jsx(B,{onClick:()=>{_(l=>[...l,{name:"",value:"",parameter_template:null,on_category:!1,use:!0}])},children:e.jsx(ce,{size:18})})})]}),e.jsxs(v,{justify:"flex-end",children:[e.jsx(b,{onClick:a,children:e.jsx(d,{id:"6Uau97"})}),e.jsx(b,{"aria-label":"action-button-import-create-parameters",disabled:r||u.filter(l=>l.use).length===0,loading:r,onClick:()=>c(u),children:e.jsx(d,{id:"OxbLDC"})})]})]})},je=({importResult:t,nextStep:r})=>e.jsxs(y,{children:[e.jsx(k,{size:"sm",children:e.jsx(d,{id:"KsybX7"})}),e.jsx(pe,{tableName:"initial-stock-creation",allowAdd:!0,showPricing:!0,showLocation:!0,params:{part:t.part_id,supplier_part:t.supplier_part_id,pricing:t.pricing,openNewStockItem:!1}}),e.jsx(v,{justify:"flex-end",children:e.jsx(b,{onClick:r,"aria-label":"action-button-import-stock-next",children:e.jsx(d,{id:"hXzOVo"})})})]});function Te({categoryId:t,partId:r}){const[a,c]=o.useState(),[n,u]=o.useState(),[_,f]=o.useState(!1),[x,j]=o.useState(null),m=_e({create:!1}),l=oe({url:z.part_list,pk:n?.part_id,title:i._({id:"enG3o5"}),fields:m}),s=o.useCallback(async({categoryId:S,partId:C})=>{f(!0);try{const A=await I.post(L(z.plugin_supplier_import),{category_id:S,part_import_id:a?.searchResult.id,plugin:a?.plugin,supplier:a?.supplier,part_id:C},{timeout:3e4});u(A.data),R({title:i._({id:"zzDlyQ"}),message:i._({id:"rzfSHc"}),color:"green"}),h.nextStep(),f(!1)}catch(A){R({title:i._({id:"SlfejT"}),message:i._({id:"Ey9Wx7"})+(A?.response?.data?.detail||A.message),color:"red"}),f(!1)}},[a]),p=o.useCallback(S=>e.jsxs(y,{gap:"xs",children:[l.modal,S>0&&a&&e.jsx(Y,{searchResult:a?.searchResult,partId:r,rightSection:n&&e.jsxs(v,{gap:"xs",children:[e.jsx(M,{to:`/part/${n.part_id}`,target:"_blank",children:e.jsx(q,{icon:"part"})}),e.jsx(B,{onClick:()=>{l.open()},children:e.jsx(q,{icon:"edit"})})]})}),S===0&&e.jsx(fe,{selectSupplierPart:C=>{c(C),h.nextStep()},partId:r}),!r&&S===1&&e.jsx(he,{isImporting:_,categoryId:t,importPart:C=>{s({categoryId:C})}}),!!r&&S===1&&e.jsxs(y,{children:[e.jsx(de,{model:D.part,pk:r}),e.jsx(k,{children:e.jsx(d,{id:"nS8G62"})}),e.jsx(v,{justify:"flex-end",children:e.jsx(b,{disabled:_,onClick:()=>{s({partId:r})},loading:_,children:e.jsx(d,{id:"l3s5ri"})})})]}),!r&&S===2&&e.jsx(ge,{importResult:n,isImporting:_,parameterErrors:x,importParameters:async C=>{f(!0),j(null);const A=C.map((g,E)=>({...g,i:E})).filter(g=>g.use),O=A.reduce((g,E,T)=>(g[E.i]=T,g),{}),J=A.map(g=>({model_type:"part",model_id:n.part_id,template:g.parameter_template,data:g.value}));try{await I.post(L(z.parameter_list),J),R({title:i._({id:"zzDlyQ"}),message:i._({id:"Io0Vgf"}),color:"green"}),h.nextStep(),f(!1)}catch(g){if(g?.response?.status===400&&Array.isArray(g.response.data)){const E=g.response.data.map(T=>{const w={};return T.data&&(w.data=T.data.join(",")),T.template&&(w.template=T.template.join(",")),w});j(C.map((T,w)=>O[w]!==void 0&&E[O[w]]?E[O[w]]:{}))}R({title:i._({id:"SlfejT"}),message:i._({id:"RxnKd7"}),color:"red"}),f(!1)}},skipStep:()=>h.nextStep()}),S===(r?2:3)&&e.jsx(je,{importResult:n,nextStep:()=>h.nextStep()}),S===(r?3:4)&&e.jsxs(y,{children:[e.jsx(k,{size:"sm",children:e.jsx(d,{id:"lzPS7p",values:{0:a?.supplier}})}),e.jsxs(v,{justify:"flex-end",children:[e.jsx(b,{component:M,to:`/part/${n?.part_id}`,variant:"light","aria-label":"action-button-import-open-part",children:e.jsx(d,{id:"lPyajd"})}),e.jsx(b,{component:M,to:`/purchasing/supplier-part/${n?.supplier_part_id}`,variant:"light",children:e.jsx(d,{id:"G9OJle"})}),e.jsx(b,{component:M,to:`/purchasing/manufacturer-part/${n?.manufacturer_part_id}`,variant:"light",children:e.jsx(d,{id:"MFoUdE"})}),e.jsx(b,{onClick:()=>h.closeWizard(),"aria-label":"action-button-import-close",children:e.jsx(d,{id:"yz7wBu"})})]})]})]}),[r,t,a,n,_,x,s,l.modal]),P=o.useCallback(()=>{c(void 0),u(void 0),f(!1),j(null),h.setStep(0)},[]),h=ue({title:i._({id:"rLfAc4"}),steps:[i._({id:"shWt6f"}),...r?[i._({id:"NhdTPX"})]:[i._({id:"K7tIrx"}),i._({id:"F18WP3"})],i._({id:"blbbPS"}),i._({id:"DPfwMq"})],onClose:P,renderStep:p,disableManualStepChange:!0});return h}export{Te as I,Ae as a,Pe as p,_e as u};
//# sourceMappingURL=ImportPartWizard-DE8Rg4Ga.js.map
