{"version":3,"file":"Alerts-BDuxLv_A.js","sources":["../../../../../../frontend/src/components/nav/Alerts.tsx"],"sourcesContent":["import { ActionIcon, Alert, Group, Menu, Stack, Tooltip } from '@mantine/core';\nimport { IconCircleCheck, IconExclamationCircle } from '@tabler/icons-react';\nimport { useMemo, useState } from 'react';\n\nimport type { SettingsStateProps } from '@lib/types/Settings';\nimport { t } from '@lingui/core/macro';\nimport { useShallow } from 'zustand/react/shallow';\nimport { docLinks } from '../../defaults/links';\nimport { useServerApiState } from '../../states/ServerApiState';\nimport { useGlobalSettingsState } from '../../states/SettingsStates';\nimport { useUserState } from '../../states/UserState';\nimport type { ServerAPIProps } from '../../states/states';\n\ninterface AlertInfo {\n  key: string;\n  title: string;\n  code?: string;\n  message: string;\n  error?: boolean;\n}\n\n/**\n * The `Alerts` component displays a menu of alerts for staff users based on the server state\n * and global settings. Alerts are shown as a dropdown menu with actionable items that can be dismissed.\n *\n * Dismissed alerts are filtered out and will not reappear in the current session.\n *\n * @returns A dropdown menu of alerts for staff users or `null` if there are no alerts or the user is not a staff member.\n */\nexport function Alerts() {\n  const user = useUserState();\n  const [server] = useServerApiState(useShallow((state) => [state.server]));\n  const globalSettings = useGlobalSettingsState();\n\n  const [dismissed, setDismissed] = useState<string[]>([]);\n\n  const alerts: ExtendedAlertInfo[] = useMemo(\n    () =>\n      getAlerts(server, globalSettings).filter(\n        (alert) => !dismissed.includes(alert.key)\n      ),\n    [server, dismissed, globalSettings]\n  );\n\n  const anyErrors: boolean = useMemo(\n    () => alerts.some((alert) => alert.error),\n    [alerts]\n  );\n  function closeAlert(key: string) {\n    setDismissed([...dismissed, key]);\n  }\n\n  if (user.isStaff() && alerts.length > 0)\n    return (\n      <Menu withinPortal={true} position='bottom-end'>\n        <Menu.Target>\n          <Tooltip position='bottom-end' label={t`Alerts`}>\n            <ActionIcon\n              variant='transparent'\n              aria-label='open-alerts'\n              color={anyErrors ? 'red' : 'orange'}\n            >\n              <IconExclamationCircle />\n            </ActionIcon>\n          </Tooltip>\n        </Menu.Target>\n        <Menu.Dropdown>\n          {alerts.map((alert) => (\n            <Menu.Item key={`alert-item-${alert.key}`}>\n              <ServerAlert alert={alert} closeAlert={closeAlert} />\n            </Menu.Item>\n          ))}\n        </Menu.Dropdown>\n      </Menu>\n    );\n  return null;\n}\n\nexport function ServerAlert({\n  alert,\n  closeAlert\n}: { alert: ExtendedAlertInfo; closeAlert?: (key: string) => void }) {\n  return (\n    <Alert\n      withCloseButton={!!closeAlert}\n      color={alert.condition ? (alert.error ? 'red' : 'orange') : 'green'}\n      icon={alert.condition ? <IconExclamationCircle /> : <IconCircleCheck />}\n      title={\n        <Group gap='xs'>\n          {alert.code && `${alert.code}: `}\n          {alert.title}\n        </Group>\n      }\n      onClose={closeAlert ? () => closeAlert(alert.key) : undefined}\n    >\n      <Stack gap='xs'>\n        {!alert.condition && t`No issues detected`}\n        {alert.condition && alert.message}\n        {alert.condition && alert.code && errorCodeLink(alert.code)}\n      </Stack>\n    </Alert>\n  );\n}\n\nexport type ExtendedAlertInfo = AlertInfo & {\n  condition: boolean;\n};\n\nexport function getAlerts(\n  server: ServerAPIProps,\n  globalSettings: SettingsStateProps,\n  inactive = false\n): ExtendedAlertInfo[] {\n  const n_migrations =\n    Number.parseInt(globalSettings.getSetting('_PENDING_MIGRATIONS')) ?? 0;\n\n  const allAlerts: ExtendedAlertInfo[] = [\n    {\n      key: 'debug',\n      title: t`Debug Mode`,\n      code: 'INVE-W4',\n      message: t`The server is running in debug mode.`,\n      condition: server?.debug_mode || false\n    },\n    {\n      key: 'worker',\n      title: t`Background Worker`,\n      code: 'INVE-W5',\n      message: t`The background worker process is not running.`,\n      condition: !server?.worker_running\n    },\n    {\n      key: 'restart',\n      title: t`Server Restart`,\n      code: 'INVE-W6',\n      message: t`The server requires a restart to apply changes.`,\n      condition: globalSettings.isSet('SERVER_RESTART_REQUIRED')\n    },\n    {\n      key: 'email',\n      title: t`Email settings`,\n      code: 'INVE-W7',\n      message: t`Email settings not configured.`,\n      condition: !server?.email_configured\n    },\n    {\n      key: 'migrations',\n      title: t`Database Migrations`,\n      code: 'INVE-W8',\n      message: t`There are pending database migrations.`,\n      condition: n_migrations > 0\n    }\n  ];\n\n  return allAlerts.filter((alert) => inactive || alert.condition);\n}\n\nexport function errorCodeLink(code: string) {\n  return (\n    <a\n      href={`${docLinks.errorcodes}#${code.toLowerCase()}`}\n      target='_blank'\n      rel='noreferrer'\n    >\n      {t`Learn more about ${code}`}\n    </a>\n  );\n}\n"],"names":["Alerts","user","useUserState","server","useServerApiState","useShallow","state","globalSettings","useGlobalSettingsState","dismissed","setDismissed","useState","alerts","useMemo","getAlerts","filter","alert","includes","key","anyErrors","some","error","closeAlert","isStaff","length","jsxs","Menu","jsx","Tooltip","_i18n","_","id","ActionIcon","IconExclamationCircle","map","ServerAlert","Alert","condition","IconCircleCheck","Group","code","title","undefined","Stack","message","errorCodeLink","inactive","n_migrations","Number","parseInt","getSetting","debug_mode","worker_running","isSet","email_configured","docLinks","errorcodes","toLowerCase","values"],"mappings":"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"}