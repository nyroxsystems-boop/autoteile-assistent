{"version":3,"file":"RemoteComponent-uZoHDwds.js","sources":["../../../../../../frontend/src/components/plugins/RemoteComponent.tsx"],"sourcesContent":["import { t } from '@lingui/core/macro';\nimport { Alert, MantineProvider, Stack, Text } from '@mantine/core';\nimport { IconExclamationCircle } from '@tabler/icons-react';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\n\nimport { identifierString } from '@lib/functions/Conversion';\nimport type { InvenTreePluginContext } from '@lib/types/Plugins';\nimport { type Root, createRoot } from 'react-dom/client';\nimport { api, queryClient } from '../../App';\nimport { ApiProvider } from '../../contexts/ApiContext';\nimport { LanguageContext } from '../../contexts/LanguageContext';\nimport { useLocalState } from '../../states/LocalState';\nimport { Boundary } from '../Boundary';\nimport { findExternalPluginFunction } from './PluginSource';\n\n/**\n * A remote component which can be used to display plugin content.\n * Content is loaded dynamically (from an external source).\n *\n * @param pluginFeature: The plugin feature to render\n * @param defaultFunctionName: The default function name to call (if not overridden by pluginFeature.source)\n * @param pluginContext: The context to pass to the plugin function\n *\n */\nexport default function RemoteComponent({\n  source,\n  defaultFunctionName,\n  context\n}: Readonly<{\n  source: string;\n  defaultFunctionName: string;\n  context: InvenTreePluginContext;\n}>) {\n  const componentRef = useRef<HTMLDivElement | null>(null);\n  const rootElement = useRef<Root | null>(null);\n\n  useEffect(() => {\n    if (componentRef.current && rootElement.current === null) {\n      rootElement.current = createRoot(componentRef.current);\n    }\n  }, [rootElement]);\n\n  const [renderingError, setRenderingError] = useState<string | undefined>(\n    undefined\n  );\n\n  const func: string = useMemo(() => {\n    // Attempt to extract the function name from the source\n    const { getHost } = useLocalState.getState();\n    const url = new URL(source, getHost());\n\n    if (url.pathname.includes(':')) {\n      const parts = url.pathname.split(':');\n      return parts[1] || defaultFunctionName; // Use the second part as the function name, or fallback to default\n    } else {\n      return defaultFunctionName;\n    }\n  }, [source, defaultFunctionName]);\n\n  const reloadPluginContent = useCallback(() => {\n    if (!rootElement.current) {\n      return;\n    }\n\n    const ctx: InvenTreePluginContext = {\n      ...context,\n      reloadContent: reloadPluginContent\n    };\n\n    if (source && defaultFunctionName) {\n      findExternalPluginFunction(source, func)\n        .then((func) => {\n          if (!!func) {\n            try {\n              if (func.length > 1) {\n                // Support \"legacy\" plugin functions which call createRoot() internally\n                // Ref: https://github.com/inventree/InvenTree/pull/9439/\n                func(componentRef.current, ctx);\n              } else {\n                // Render the plugin component into the target element\n                // Note that we have to provide the right context(s) to the component\n                // This approach ensures that the component is rendered in the correct context tree\n                rootElement.current?.render(\n                  <ApiProvider client={queryClient} api={api}>\n                    <MantineProvider\n                      theme={ctx.theme}\n                      defaultColorScheme={ctx.colorScheme}\n                    >\n                      <LanguageContext>{func(ctx)}</LanguageContext>\n                    </MantineProvider>\n                  </ApiProvider>\n                );\n              }\n\n              setRenderingError('');\n            } catch (error) {\n              setRenderingError(`${error}`);\n              console.error(error);\n            }\n          } else {\n            setRenderingError(`${source} / ${func}`);\n          }\n        })\n        .catch((_error) => {\n          console.error(\n            `ERR: Failed to load remote plugin function: ${source} /${func}`\n          );\n        });\n    } else {\n      setRenderingError(\n        `${t`Invalid source or function name`} - ${source} /${func}`\n      );\n    }\n  }, [\n    componentRef.current,\n    rootElement.current,\n    source,\n    defaultFunctionName,\n    context\n  ]);\n\n  // Reload the plugin content dynamically\n  useEffect(() => {\n    reloadPluginContent();\n  }, [\n    func,\n    rootElement.current,\n    context.id,\n    context.model,\n    context.instance,\n    context.user,\n    context.colorScheme,\n    context.locale,\n    context.context\n  ]);\n\n  return (\n    <Boundary label={identifierString(`RemoteComponent-${func}`)}>\n      <Stack gap='xs'>\n        {renderingError && (\n          <Alert\n            color='red'\n            title={t`Error Loading Content`}\n            icon={<IconExclamationCircle />}\n          >\n            <Text>\n              {t`Error occurred while loading plugin content`}: {renderingError}\n            </Text>\n          </Alert>\n        )}\n        {componentRef && <div ref={componentRef as any} />}\n      </Stack>\n    </Boundary>\n  );\n}\n"],"names":["RemoteComponent","source","defaultFunctionName","context","componentRef","useRef","rootElement","useEffect","current","createRoot","renderingError","setRenderingError","useState","undefined","func","useMemo","getHost","useLocalState","getState","url","URL","pathname","includes","split","reloadPluginContent","useCallback","ctx","reloadContent","findExternalPluginFunction","then","length","render","jsx","ApiProvider","queryClient","api","MantineProvider","theme","colorScheme","LanguageContext","error","console","catch","_error","_i18n","_","id","model","instance","user","locale","Boundary","identifierString","jsxs","Stack","Alert","IconExclamationCircle","Text"],"mappings":"4RAwBA,SAAwBA,EAAgB,CACtCC,OAAAA,EACAC,oBAAAA,EACAC,QAAAA,CAKD,EAAG,CACF,MAAMC,EAAeC,EAAAA,OAA8B,IAAI,EACjDC,EAAcD,EAAAA,OAAoB,IAAI,EAE5CE,EAAAA,UAAU,IAAM,CACVH,EAAaI,SAAWF,EAAYE,UAAY,OAClDF,EAAYE,QAAUC,aAAWL,EAAaI,OAAO,EAEzD,EAAG,CAACF,CAAW,CAAC,EAEhB,KAAM,CAACI,EAAgBC,CAAiB,EAAIC,EAAAA,SAC1CC,MACF,EAEMC,EAAeC,EAAAA,QAAQ,IAAM,CAEjC,KAAM,CAAEC,QAAAA,CAAAA,EAAYC,EAAcC,SAAAA,EAC5BC,EAAM,IAAIC,IAAInB,EAAQe,GAAS,EAErC,OAAIG,EAAIE,SAASC,SAAS,GAAG,GACbH,EAAIE,SAASE,MAAM,GAAG,EACvB,CAAC,GAAKrB,CAIvB,EAAG,CAACD,EAAQC,CAAmB,CAAC,EAE1BsB,EAAsBC,EAAAA,YAAY,IAAM,CAC5C,GAAI,CAACnB,EAAYE,QACf,OAGF,MAAMkB,EAA8B,CAClC,GAAGvB,EACHwB,cAAeH,CAAAA,EAGbvB,GAAUC,EACZ0B,EAA2B3B,EAAQa,CAAI,EACpCe,KAAMf,GAAS,CACd,GAAMA,EACJ,GAAI,CACEA,EAAKgB,OAAS,EAGhBhB,EAAKV,EAAaI,QAASkB,CAAG,EAK9BpB,EAAYE,SAASuB,OACnBC,EAAAA,IAACC,EAAA,CAAY,OAAQC,EAAa,IAAAC,EAChC,SAAAH,EAAAA,IAACI,EAAA,CACC,MAAOV,EAAIW,MACX,mBAAoBX,EAAIY,YAExB,SAAAN,EAAAA,IAACO,EAAA,CAAiBzB,SAAAA,EAAKY,CAAG,CAAA,CAAE,CAAA,CAC9B,CAAA,CACF,CACF,EAGFf,EAAkB,EAAE,CACtB,OAAS6B,EAAO,CACd7B,EAAkB,GAAG6B,CAAK,EAAE,EAC5BC,QAAQD,MAAMA,CAAK,CACrB,MAEA7B,EAAkB,GAAGV,CAAM,MAAMa,CAAI,EAAE,CAE3C,CAAC,EACA4B,MAAOC,GAAW,CACjBF,QAAQD,MACN,+CAA+CvC,CAAM,KAAKa,CAAI,EAChE,CACF,CAAC,EAEHH,EACE,GAAAiC,EAAAC,EAAG,CAAAC,GAAA,QAAA,CAAiC,CAAC,MAAM7C,CAAM,KAAKa,CAAI,EAC5D,CAEJ,EAAG,CACDV,EAAaI,QACbF,EAAYE,QACZP,EACAC,EACAC,CAAO,CACR,EAGDI,OAAAA,EAAAA,UAAU,IAAM,CACdiB,EAAAA,CACF,EAAG,CACDV,EACAR,EAAYE,QACZL,EAAQ2C,GACR3C,EAAQ4C,MACR5C,EAAQ6C,SACR7C,EAAQ8C,KACR9C,EAAQmC,YACRnC,EAAQ+C,OACR/C,EAAQA,OAAO,CAChB,EAGC6B,EAAAA,IAACmB,EAAA,CAAS,MAAOC,EAAiB,mBAAmBtC,CAAI,EAAE,EACzD,SAAAuC,EAAAA,KAACC,EAAA,CAAM,IAAI,KACR5C,SAAAA,CAAAA,GACCsB,EAAAA,IAACuB,EAAA,CACC,MAAM,MACN,MAAMX,EAAAC,EAAC,CAAAC,GAAA,QAAA,CAAuB,EAC9B,KAAMd,MAACwB,EAAA,CAAA,GAEP,gBAACC,EAAA,CACCb,SAAAA,CAAAA,EAAAC,EAAC,CAAAC,GAAA,QAAA,CAA6C,EAAE,KAAGpC,CAAAA,CAAAA,CACrD,CAAA,CACF,EAEDN,GAAgB4B,EAAAA,IAAC,MAAA,CAAI,IAAK5B,CAAAA,CAAoB,CAAA,CAAA,CACjD,CAAA,CACF,CAEJ"}