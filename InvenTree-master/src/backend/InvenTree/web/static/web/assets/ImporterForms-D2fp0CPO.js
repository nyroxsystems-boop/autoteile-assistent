import{r,cy as B,ao as _,bb as V,bE as A,j as e,ab as n,an as k,N as g,d as b,a7 as U,bF as I,a8 as q,S,$ as P,al as y,bg as Y,O as Q,aq as O,ak as m,aw as $,C as H,bd as J,aj as K,b9 as W,bO as v}from"./index-Db7AGPIq.js";import{u as X}from"./UseInstance-BPJQEWDW.js";import{aq as Z,b as ee,c as se,M as te,u as re,N as ae,ar as le}from"./Filter-BgnAqEQC.js";import{aP as L,S as G}from"./ThemeContext-CxdCkKtz.js";import{A as ie}from"./ActionButton-Cv5j5I5R.js";import{P as ne}from"./index-DRtKJP-e.js";import{u as oe,R as de,a as ce,I as ue}from"./InvenTreeTable-DmN557zY.js";import{Y as pe}from"./YesNoButton-BaVgP5u9.js";import{u as M}from"./DesktopAppView-BuH2j218.js";import{b as z}from"./IconChevronDown-CzbIU38Y.js";import{I as fe}from"./IconCircleDashedCheck-DnGBn8Eq.js";function he(t,s,{autoInvoke:l=!1}={}){const[o,d]=r.useState(!1),f=r.useRef(null),c=r.useRef(null),h=r.useCallback(()=>{d(j=>(!j&&(!f.current||f.current===-1)&&(f.current=window.setInterval(c.current,s)),!0))},[]),p=r.useCallback(()=>{d(!1),window.clearInterval(f.current||-1),f.current=-1},[]),u=r.useCallback(()=>{o?p():h()},[o]);return r.useEffect(()=>(c.current=t,o&&h(),p),[t,o,s]),r.useEffect(()=>{l&&h()},[]),{start:h,stop:p,toggle:u,active:o}}function N({modelType:t}){const s=B.getState().status;return r.useMemo(()=>{const o=Z(t)||null,d={};return o&&Object.keys(o.values).forEach(f=>{d[f]=o.values[f].key}),d},[t,s])}function xe({sessionId:t}){const{instance:s,setInstance:l,refreshInstance:o,instanceQuery:d}=X({endpoint:_.import_session_list,pk:t,defaultValue:{}}),f=r.useCallback(i=>{l(i)},[]);N({modelType:V.importsession});const[c,h]=r.useState(0);r.useEffect(()=>{h(0)},[t]),r.useEffect(()=>{s.status&&s.status!==c&&h(s.status)},[s?.status]);const p=r.useMemo(()=>s?.available_fields??[],[s]),u=r.useMemo(()=>{let i=s?.columns??[];return i=i.filter(a=>!!a),i=i.filter((a,x)=>i.indexOf(a)===x),i},[s.columns]),j=r.useMemo(()=>{let i=s?.column_mappings?.map(a=>({...a,...p[a.field]??{}}))??[];return i=i.sort((a,x)=>a?.required&&!x?.required?-1:!a?.required&&x?.required?1:0),i},[s,u]),C=r.useMemo(()=>s?.column_mappings?.filter(i=>!!i.column)??[],[s]),D=r.useMemo(()=>s?.field_defaults??{},[s]),T=r.useMemo(()=>s?.field_overrides??{},[s]),F=r.useMemo(()=>s?.field_filters??{},[s]),R=r.useMemo(()=>s?.row_count??0,[s]),E=r.useMemo(()=>s?.completed_row_count??0,[s]);return{sessionData:s,setSessionData:f,sessionId:t,refreshSession:o,sessionQuery:d,status:c,availableFields:p,availableColumns:u,columnMappings:j,mappedFields:C,fieldDefaults:D,fieldOverrides:T,fieldFilters:F,rowCount:R,completedRowCount:E}}function me({session:t,column:s,row:l,onEdit:o}){const d=r.useCallback(p=>{Y(p),l.complete||o?.()},[o,l]),f=r.useMemo(()=>l.errors?l?.errors[s.field]??[]:[],[l.errors,s.field]),c=r.useMemo(()=>{const p=t.availableFields[s.field];if(!l?.data)return"-";switch(p?.type){case"boolean":return e.jsx(pe,{value:l.data?l.data[s.field]:!1});case"related field":if(p.model&&l.data[s.field])return e.jsx(te,{model:p.model,pk:l.data[s.field]});break}let u=l.data?l.data[s.field]??"":"";return u||(u="-"),u},[l.data,s.field,t.availableFields]),h=r.useMemo(()=>f.length==0,[f]);return e.jsxs(I,{disabled:h,openDelay:100,closeDelay:100,children:[e.jsx(I.Target,{children:e.jsx(g,{grow:!0,justify:"apart",onClick:d,children:e.jsx(g,{grow:!0,style:{flex:1},children:e.jsx(b,{size:"xs",c:h?void 0:"red",children:c})})})}),e.jsx(I.Dropdown,{children:e.jsx(S,{gap:"xs",children:f.map(p=>e.jsx(b,{size:"xs",c:"red",children:p},p))})})]})}function je({session:t}){const s=M(),l=oe("dataimporter"),[o,d]=r.useState([]),f=r.useMemo(()=>{const i={};for(const a of o){const x=t.availableFields[a];if(x){let w=x.filters??{};if(t.fieldFilters[a]&&(w={...w,...t.fieldFilters[a]}),a=="id")continue;i[a]={...x,field_type:x.type,description:x.help_text,filters:w}}}return i},[o,t.availableFields,t.fieldFilters]),c=r.useCallback(i=>{A.show({title:n._({id:"fawxGh"}),message:n._({id:"SdvoV5"}),autoClose:!1,color:"blue",id:"importing-rows",icon:e.jsx(z,{})}),s.post(k(_.import_session_accept_rows,t.sessionId),{rows:i}).catch(()=>{A.show({title:n._({id:"SlfejT"}),message:n._({id:"aydx5i"}),color:"red",autoClose:!0})}).finally(()=>{l.clearSelectedRecords(),A.hide("importing-rows"),l.refreshTable(),t.refreshSession()})},[t.sessionId,l.refreshTable]),[h,p]=r.useState({}),u=ee({url:_.import_session_row_list,pk:h.pk,title:n._({id:"bo3Q/V"}),fields:f,initialData:h.data,fetchInitialData:!1,processFormData:i=>({data:{...h.data,...i}}),onFormSuccess:i=>l.updateRecord(i)}),j=r.useCallback((i,a)=>{a.field!="id"&&(p(i),d([a.field]),u.open())},[t,u]),C=se({url:_.import_session_row_list,pk:h.pk,title:n._({id:"f2AJjl"}),onFormSuccess:()=>l.refreshTable()}),D=r.useCallback(i=>{if(!i.errors)return[];const a=[];for(const x of Object.keys(i.errors))i.errors[x]&&(Array.isArray(i.errors[x])?i.errors[x].forEach(w=>{a.push(`${x}: ${w}`)}):a.push(i.errors[x].toString()));return a},[]),T=r.useMemo(()=>[{accessor:"row_index",title:n._({id:"IqKCNQ"}),sortable:!0,switchable:!1,render:a=>e.jsxs(g,{justify:"left",gap:"xs",children:[e.jsx(b,{size:"sm",children:a.row_index}),a.complete&&e.jsx(U,{color:"green",size:16}),!a.complete&&a.valid&&e.jsx(fe,{color:"blue",size:16}),!a.complete&&!a.valid&&e.jsxs(I,{openDelay:50,closeDelay:100,position:"top-start",children:[e.jsx(I.Target,{children:e.jsx(q,{color:"red",size:16})}),e.jsx(I.Dropdown,{children:e.jsxs(S,{gap:"xs",children:[e.jsxs(b,{children:[n._({id:"H14AdY"}),":"]}),D(a).map(x=>e.jsx(b,{size:"sm",c:"red",children:x},x))]})})]})]})},...t.mappedFields.map(a=>({accessor:a.field,title:a.label??a.column,sortable:!1,switchable:!0,render:x=>e.jsx(me,{session:t,column:a,row:x,onEdit:()=>j(x,a)})}))],[t]),F=r.useCallback(i=>[{title:n._({id:"g3UF2V"}),icon:e.jsx(z,{}),color:"green",hidden:i.complete||!i.valid,onClick:()=>{c([i.pk])}},de({hidden:i.complete,onClick:()=>{p(i),d(t.mappedFields.map(a=>a.field)),u.open()}}),ce({onClick:()=>{p(i),C.open()}})],[t,c]),R=r.useMemo(()=>[{name:"valid",label:n._({id:"nfagfM"}),description:n._({id:"p385PV"}),type:"boolean"},{name:"complete",label:n._({id:"bD8I7O"}),description:n._({id:"ytCibL"}),type:"boolean"}],[]),E=r.useMemo(()=>{const i=l.hasSelectedRecords&&l.selectedRecords.every(a=>a.valid&&!a.complete);return[e.jsx(ie,{disabled:!i,icon:e.jsx(z,{}),color:"green",tooltip:n._({id:"Fgr3ay"}),onClick:()=>{c(l.selectedRecords.map(a=>a.pk))}},"import-selected-rows")]},[l.hasSelectedRecords,l.selectedRecords]);return e.jsxs(e.Fragment,{children:[u.modal,C.modal,e.jsxs(S,{gap:"xs",children:[e.jsx(P,{shadow:"xs",p:"xs",children:e.jsxs(g,{grow:!0,justify:"apart",children:[e.jsx(b,{size:"lg",children:n._({id:"6dO0jk"})}),e.jsx(y,{}),e.jsx(ne,{maximum:t.rowCount,value:t.completedRowCount,progressLabel:!0}),e.jsx(y,{})]})}),e.jsx(ue,{tableState:l,columns:T,url:k(_.import_session_row_list),props:{params:{session:t.sessionId},rowActions:F,tableActions:E,tableFilters:R,enableColumnSwitching:!0,enableColumnCaching:!1,enableSelection:!0,enableBulkDelete:!0,afterBulkDelete:()=>{t.refreshSession()}}})]})]})}function be({column:t,options:s}){const l=M(),[o,d]=r.useState(""),[f,c]=r.useState(t.column??"");r.useEffect(()=>{c(t.column??"")},[t.column]);const h=r.useCallback(p=>{l.patch(k(_.import_session_column_mapping_list,t.pk),{column:p||""}).then(u=>{c(u.data?.column??p),d("")}).catch(u=>{const j=u.response.data;d(j.column??j.non_field_errors??n._({id:"Vw8l6h"}))})},[t]);return e.jsx($,{"aria-label":`import-column-map-${t.field}`,error:o,clearable:!0,searchable:!0,placeholder:n._({id:"TJu1/1"}),label:void 0,data:s,value:f,onChange:h})}function _e({fieldName:t,session:s}){const l=M(),[o,d]=r.useState(""),f=r.useMemo(()=>s.availableFields[t]?.type,[t,s.availableFields]),[c]=re(o,f=="string"?500:10),h=r.useCallback(u=>{const j={...s.fieldDefaults,[t]:u};l.patch(k(_.import_session_list,s.sessionId),{field_defaults:j}).then(C=>{s.setSessionData(C.data)}).catch(()=>{})},[t,s,s.fieldDefaults]);r.useEffect(()=>{h(c)},[c]);const p=r.useMemo(()=>{let u=s.availableFields[t];return u&&(u={...u,value:s.fieldDefaults[t],field_type:u.type,description:u.help_text,required:!1,onValueChange:j=>{d(j)}}),u},[t,s.availableFields,s.fieldDefaults]);return p&&e.jsx(ae,{fieldDefinition:p,hideLabels:!0})}function Se({session:t,column:s,options:l}){return e.jsxs(m.Tr,{children:[e.jsx(m.Td,{children:e.jsxs(g,{gap:"xs",children:[e.jsx(b,{fw:s.required?700:void 0,children:s.label??s.field}),s.required&&e.jsx(b,{c:"red",fw:700,children:"*"})]})}),e.jsx(m.Td,{children:e.jsx(b,{size:"sm",children:s.description})}),e.jsx(m.Td,{children:e.jsx(be,{column:s,options:l})}),e.jsx(m.Td,{children:e.jsx(_e,{fieldName:s.field,session:t})})]},s.label??s.field)}function ge({session:t}){const s=M(),[l,o]=r.useState(""),d=r.useCallback(()=>{const c=k(_.import_session_accept_fields,t.sessionId);s.post(c).then(()=>{t.refreshSession()}).catch(h=>{o(h.response?.data?.error??n._({id:"Vw8l6h"}))})},[t.sessionId]),f=r.useMemo(()=>[{value:"",label:n._({id:"ojDp4A"})},...t.availableColumns.map(c=>({value:c,label:c}))],[t.availableColumns]);return e.jsxs(S,{gap:"xs",children:[e.jsx(P,{shadow:"xs",p:"xs",children:e.jsxs(g,{grow:!0,justify:"apart",children:[e.jsx(b,{size:"lg",children:n._({id:"AHjxLx"})}),e.jsx(y,{}),e.jsx(Q,{color:"green",variant:"filled",onClick:d,children:e.jsxs(g,{children:[e.jsx(L,{}),n._({id:"Y+Sfcf"})]})})]})}),l&&e.jsx(O,{color:"red",title:n._({id:"SlfejT"}),children:e.jsx(b,{children:l})}),e.jsxs(m,{children:[e.jsx(m.Thead,{children:e.jsxs(m.Tr,{children:[e.jsx(m.Th,{children:n._({id:"3mVQ03"})}),e.jsx(m.Th,{children:n._({id:"Us9epU"})}),e.jsx(m.Th,{children:n._({id:"qsUkVg"})}),e.jsx(m.Th,{children:n._({id:"aQ8swY"})})]})}),e.jsx(m.Tbody,{children:t.columnMappings.map(c=>e.jsx(Se,{session:t,column:c,options:f},`import-${c.field}}`))})]})]})}function Ce({session:t}){const s=r.useMemo(()=>le(V.importsession,t.status)||n._({id:"SC1Cur"}),[t.status]);return he(()=>{t.refreshSession()},1e3,{autoInvoke:!0}),e.jsx(H,{style:{height:"100%"},children:e.jsxs(S,{gap:"xs",align:"center",justify:"center",children:[e.jsx(G,{size:"lg",children:s}),e.jsx(J,{})]})})}function ve({currentStep:t}){return e.jsxs(v,{active:t,onStepClick:void 0,allowNextStepsSelect:!1,iconSize:20,size:"xs",children:[e.jsx(v.Step,{label:n._({id:"IQ3gAw"})}),e.jsx(v.Step,{label:n._({id:"KXVPhI"})}),e.jsx(v.Step,{label:n._({id:"FhMhTR"})}),e.jsx(v.Step,{label:n._({id:"eHQfWJ"})}),e.jsx(v.Step,{label:n._({id:"b8ESNU"})})]})}function ze({sessionId:t,opened:s,onClose:l}){const o=xe({sessionId:t}),d=N({modelType:V.importsession}),f=r.useMemo(()=>{switch(o.status){case d.INITIAL:return 0;case d.MAPPING:return 1;case d.IMPORTING:return 2;case d.PROCESSING:return 3;case d.COMPLETE:return 4;default:return 0}},[o.status]),c=r.useMemo(()=>{if(o.sessionQuery.isError)return e.jsx(O,{color:"red",title:n._({id:"SlfejT"}),icon:e.jsx(q,{}),children:n._({id:"mfQdnw"})});switch(o.status){case d.MAPPING:return e.jsx(ge,{session:o});case d.PROCESSING:return e.jsx(je,{session:o});case d.COMPLETE:return e.jsxs(S,{gap:"xs",children:[e.jsx(O,{color:"green",title:n._({id:"4fgz8U"}),icon:e.jsx(L,{}),children:n._({id:"zdT9Dy"})}),e.jsx(Q,{color:"blue",onClick:l,children:n._({id:"yz7wBu"})})]});default:return e.jsx(Ce,{session:o})}},[o.status,o.sessionQuery]),h=r.useMemo(()=>e.jsxs(S,{gap:"xs",style:{width:"100%"},children:[e.jsxs(g,{gap:"xs",wrap:"nowrap",justify:"space-apart",grow:!0,preventGrowOverflow:!1,children:[e.jsx(G,{size:"lg",children:o.sessionData?.statusText??n._({id:"CTRRU5"})}),e.jsx(ve,{currentStep:f}),e.jsx(y,{})]}),e.jsx(K,{})]}),[o.sessionData]);return e.jsx(W,{position:"bottom",size:"80%",title:h,opened:s,onClose:l,withCloseButton:!0,closeOnEscape:!1,closeOnClickOutside:!1,styles:{header:{width:"100%"},title:{width:"100%"}},children:e.jsx(S,{gap:"xs",children:e.jsx(P,{p:"md",children:c})})})}function Oe({modelType:t,allowUpdate:s=!1}){return{data_file:{},model_type:{value:t,hidden:t!=null},update_records:{hidden:s!==!0,value:s?void 0:!1},field_defaults:{hidden:!0,value:{}},field_overrides:{hidden:!0,value:{}},field_filters:{hidden:!0,value:{}}}}export{ze as I,Oe as d,N as u};
//# sourceMappingURL=ImporterForms-D2fp0CPO.js.map
